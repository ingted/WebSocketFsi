(function(a){"use strict";var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;b=a.WebSharper=a.WebSharper||{};c=b.AspNetCore=b.AspNetCore||{};d=c.WebSocket=c.WebSocket||{};e=d.Async=d.Async||{};f=b&&b.Obj;g=d.WebSocketEndpoint=d.WebSocketEndpoint||{};h=d.Client=d.Client||{};i=h.Message=h.Message||{};j=h.WebSocketServer=h.WebSocketServer||{};k=h.WithEncoding=h.WithEncoding||{};l=b&&b.Control;m=l&&l.MailboxProcessor;n=b&&b.Concurrency;o=a.IntelliFactory;p=o&&o.Runtime;q=a.JSON;r=b&&b.Json;s=b&&b.Seq;e.FoldAgent=function(t,u){return m.Start(function(v){function w(x){var y;y=null;return n.Delay(function(){return n.Bind(v.Receive(null),function(z){return n.Bind(u(x,z),function(A){return w(A);});});});}return w(t);},null);};g=d.WebSocketEndpoint=p.Class({get_JsonEncoding:function(){return this.JsonEncoding;},get_URI:function(){return this.uri;}},f,g);g.New=p.Ctor(function(t){f.New.call(this);this.uri=t;this.JsonEncoding={$:0};},g);i.Close={$:3};i.Open={$:2};i.Error={$:1};j=h.WebSocketServer=p.Class({Post:function(t){this.conn.send(this.encode(t));},get_Connection:function(){return this.conn;}},f,j);j.New=p.Ctor(function(t,u){f.New.call(this);this.conn=t;this.encode=u;},j);k.Connect=function(t,u,v,w){return k.FromWebSocket(t,u,new a.WebSocket(v.get_URI()),w,v.get_JsonEncoding());};k.ConnectStateful=function(t,u,v,w){return k.FromWebSocketStateful(t,u,new a.WebSocket(v.get_URI()),w,v.get_JsonEncoding());};k.FromWebSocket=function(t,u,v,w,x){var y,z,A,B,C;y=h.getEncoding(t,u,x);z=y[1];A=h.cacheSocket(v,z);B=new j.New(v,y[0]);C=null;return n.Delay(function(){return n.Bind(w(B),function(D){function E(F,G){var H;H=A(D);v.onopen=function(){D(i.Open);return F(B);};v.onclose=function(){return D(i.Close);};v.onmessage=function(I){return D({$:0,$0:z(I)});};v.onerror=function(){D(i.Error);return G(new a.Error("Could not connect to the server."));};H?F(B):void 0;}return n.FromContinuations(function(F,G,H){return E.apply(null,[F,G,H]);});});});};k.FromWebSocketStateful=function(t,u,v,w,x){var y,z,A,B,C;y=h.getEncoding(t,u,x);z=y[1];A=h.cacheSocket(v,z);B=new j.New(v,y[0]);C=null;return n.Delay(function(){return n.Bind(w(B),function(D){var E,F;function G(H,I){var J;J=A(function(K){F.mailbox.AddLast(K);F.resume();});v.onopen=function(){F.mailbox.AddLast(i.Open);F.resume();return H(B);};v.onclose=function(){F.mailbox.AddLast(i.Close);return F.resume();};v.onmessage=function(K){F.mailbox.AddLast({$:0,$0:z(K)});return F.resume();};v.onerror=function(){F.mailbox.AddLast(i.Error);F.resume();return I(new a.Error("Could not connect to the server."));};J?H(B):void 0;}E=D[1];F=e.FoldAgent(D[0],function(H,I){return(E(H))(I);});return n.FromContinuations(function(H,I,J){return G.apply(null,[H,I,J]);});});});};h.getEncoding=function(t,u,v){var w,x;function y(z){return q.parse(z);}w=v.$==0?[function(z){return q.stringify(z);},function(z){return r.Activate(y(z));}]:[t,u];x=w[1];return[w[0],function(z){return x(z.data);}];};h.cacheSocket=function(t,u){var v,w;v=[];w=[false];t.onopen=function(){v.push(i.Open);w[0]=true;};t.onclose=function(){return v.push(i.Close);};t.onmessage=function(x){return v.push({$:0,$0:u(x)});};t.onerror=function(){return v.push(i.Error);};return function(x){s.iter(x,v);return w[0];};};}(self));
